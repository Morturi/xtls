"use strict";(self.webpackChunkXray_docs_next=self.webpackChunkXray_docs_next||[]).push([[1195],{4614:(n,s,e)=>{e.r(s),e.d(s,{data:()=>a});const a={key:"v-05ddc65d",path:"/en/document/level-2/iptables_gid.html",title:"Transparent proxy via GID",lang:"en-US",frontmatter:{title:"Transparent proxy via GID"},excerpt:"",headers:[{level:2,title:"Ideas",slug:"ideas",children:[]},{level:2,title:"Configuration Procedure",slug:"configuration-procedure",children:[{level:3,title:"1. Preliminary preparation",slug:"_1-preliminary-preparation",children:[]},{level:3,title:"2. Add user (Android users please ignore this section)",slug:"_2-add-user-android-users-please-ignore-this-section",children:[]},{level:3,title:"3. Configure and run Xray, and configure iptables rules",slug:"_3-configure-and-run-xray-and-configure-iptables-rules",children:[]}]},{level:2,title:"Steps",slug:"steps",children:[{level:3,title:"1. Finish Preliminary preparation and Add user",slug:"_1-finish-preliminary-preparation-and-add-user",children:[]},{level:3,title:"2. Preparing Xray profiles",slug:"_2-preparing-xray-profiles",children:[]},{level:3,title:"3. Configuring the maximum number of open files and run the Xray client",slug:"_3-configuring-the-maximum-number-of-open-files-and-run-the-xray-client",children:[]},{level:3,title:"4. Setting up iptables rules",slug:"_4-setting-up-iptables-rules",children:[]}]}],filePathRelative:"en/document/level-2/iptables_gid.md",git:{updatedTime:1622031944e3,contributors:[{name:"hmol233",email:"82594500+hmol233@users.noreply.github.com",commits:2},{name:"R3pl4c3r",email:"30682790+R3pl4c3r@users.noreply.github.com",commits:1}]}}},4900:(n,s,e)=>{e.r(s),e.d(s,{default:()=>C});var a=e(6252);const r=(0,a._)("h1",{id:"transparent-proxy-to-circumvent-xray-traffic-via-gid",tabindex:"-1"},[(0,a._)("a",{class:"header-anchor",href:"#transparent-proxy-to-circumvent-xray-traffic-via-gid","aria-hidden":"true"},"#"),(0,a.Uk)(" Transparent proxy to circumvent Xray traffic via GID")],-1),t=(0,a.Uk)("In the existing transparent proxy configuration("),p={href:"https://guide.v2fly.org/app/transparent_proxy.html",target:"_blank",rel:"noopener noreferrer"},o=(0,a.Uk)("New V2Ray vernacular tutorial on transparent proxy"),l=(0,a.Uk)(" 、 "),i={href:"https://guide.v2fly.org/app/tproxy.html",target:"_blank",rel:"noopener noreferrer"},u=(0,a.Uk)("New V2Ray vernacular tutorial on transparent proxy (TProxy)"),c=(0,a.Uk)(" 、 "),d=(0,a.Uk)("Transparent proxy（TProxy）configuration tutorial"),m=(0,a.Uk)(")tutorials, the circumvention of Xray traffic is achieved by using mark. That is, mark outbound traffics and set up iptables rules which directly connect traffics corresponding to the mark, to circumvent the Xray traffic and prevent loop back."),b=(0,a._)("p",null,"There are several problems with this method:",-1),h={href:"https://github.com/v2ray/v2ray-core/issues/2621",target:"_blank",rel:"noopener noreferrer"},g=(0,a.Uk)("Inexplicable traffic into PREROUTING chain"),f=(0,a._)("li",null,[(0,a._)("p",null,"Android has its own mark mechanism and this solution is not available on Android")],-1),y=(0,a.uE)('<p>The solution in this tutorial does not require a mark setting and has a higher theoretical performance, as well as not having the problems mentioned above.</p><h2 id="ideas" tabindex="-1"><a class="header-anchor" href="#ideas" aria-hidden="true">#</a> Ideas</h2><p>TProxy traffic can only be received by users with root privileges (uid==0) or other users with CAP_NET_ADMIN privileges.</p><p>The iptables rules can separate network traffic by uid (user id) and gid (user group id). Let Xray run on a user with uid==0 but gid!=0. Set the iptables rule to not proxy traffic for that gid to circumvent Xray traffic.</p><h2 id="configuration-procedure" tabindex="-1"><a class="header-anchor" href="#configuration-procedure" aria-hidden="true">#</a> Configuration Procedure</h2><h3 id="_1-preliminary-preparation" tabindex="-1"><a class="header-anchor" href="#_1-preliminary-preparation" aria-hidden="true">#</a> 1. Preliminary preparation</h3><p><strong>Android</strong></p>',7),k=(0,a._)("li",null,[(0,a._)("p",null,"System has root privilege.")],-1),x=(0,a.Uk)("Install "),v={href:"https://play.google.com/store/apps/details?id=stericson.busybox",target:"_blank",rel:"noopener noreferrer"},_=(0,a.Uk)("busybox"),A=(0,a._)("li",null,[(0,a._)("p",null,"There is a terminal that can execute commands, you can use adb shell, termux etc.")],-1),w=(0,a.uE)('<p><strong>Other Linux system</strong></p><p>Need sudo, iptables-tproxy module and iptables-extra module。</p><p>Usually the system comes with these functions. If you are using openwrt, you will need to run the following command:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>opkg <span class="token function">install</span> <span class="token function">sudo</span> iptables-mod-tproxy iptables-mod-extra\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>Also attached are some common dependencies for openwrt, the lack of which may prevent Xray from running</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>opkg <span class="token function">install</span> libopenssl ca-certificates\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="_2-add-user-android-users-please-ignore-this-section" tabindex="-1"><a class="header-anchor" href="#_2-add-user-android-users-please-ignore-this-section" aria-hidden="true">#</a> 2. Add user (Android users please ignore this section)</h3><p>Android does not support managing users by modifying the /etc/passwd file, please ignore it and go straight to the next step.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">grep</span> -qw xray_tproxy /etc/passwd <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;xray_tproxy:x:0:23333:::&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/passwd\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>where xray_tproxy is the username, 0 is the uid and 23333 is the gid, the username and gid can be set by yourself, the uid must be 0. To check if the user was added successfully, run</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> -u xray_tproxy <span class="token function">id</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>The result displayed should be uid 0 and gid 23333.</p><h3 id="_3-configure-and-run-xray-and-configure-iptables-rules" tabindex="-1"><a class="header-anchor" href="#_3-configure-and-run-xray-and-configure-iptables-rules" aria-hidden="true">#</a> 3. Configure and run Xray, and configure iptables rules</h3>',13),q=(0,a.Uk)("In the existing transparent proxy configuration("),R={href:"https://guide.v2fly.org/app/transparent_proxy.html",target:"_blank",rel:"noopener noreferrer"},T=(0,a.Uk)("New V2Ray vernacular tutorial on transparent proxy"),X=(0,a.Uk)(" 、 "),U={href:"https://guide.v2fly.org/app/tproxy.html",target:"_blank",rel:"noopener noreferrer"},P=(0,a.Uk)("New V2Ray vernacular tutorial on transparent proxy (TProxy)"),Y=(0,a.Uk)(" 、 "),N=(0,a._)("strong",null,[(0,a._)("a",{href:"../tproxy"},"Transparent proxy（TProxy）configuration tutorial")],-1),j=(0,a.Uk)(")tutorials, modify:"),E=(0,a.uE)('<ol><li><p>Modify the json configuration file: remove mark-related content</p></li><li><p>Modify the iptables rule to remove the mark-related content and add the option at the OUTPUT chain application rule: <code>-m owner ! --gid-owner 23333</code></p></li></ol><p>e.g.:</p><p><code>iptables -t mangle -A OUTPUT -j XRAY_SELF</code></p><p>Change to</p><p><code>iptables -t mangle -A OUTPUT -m owner ! --gid-owner 23333 -j XRAY_SELF</code></p><ol><li>Modify the way you run Xray so that it runs on a user with uid 0 and gid 23333, refer to <a href="#_3-configure-and-run-xray-and-configure-iptables-rules">here</a>.</li></ol><h2 id="steps" tabindex="-1"><a class="header-anchor" href="#steps" aria-hidden="true">#</a> Steps</h2><p>The following provides a complete configuration process for implementing the tproxy global proxy</p><h3 id="_1-finish-preliminary-preparation-and-add-user" tabindex="-1"><a class="header-anchor" href="#_1-finish-preliminary-preparation-and-add-user" aria-hidden="true">#</a> 1. Finish <strong><a href="#_1-preliminary-preparation">Preliminary preparation</a></strong> and <strong><a href="#_2-add-user-android-users-please-ignore-this-section">Add user</a></strong></h3><h3 id="_2-preparing-xray-profiles" tabindex="-1"><a class="header-anchor" href="#_2-preparing-xray-profiles" aria-hidden="true">#</a> 2. Preparing Xray profiles</h3><p>Configure Xray to listen to 12345 at dokodemo-door, turn on followRedirect and tproxy, no sniffing required:</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>\n  <span class="token property">&quot;inbounds&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">12345</span><span class="token punctuation">,</span>\n      <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dokodemo-door&quot;</span><span class="token punctuation">,</span>\n      <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">&quot;network&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tcp,udp&quot;</span><span class="token punctuation">,</span>\n        <span class="token property">&quot;followRedirect&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>\n      <span class="token punctuation">}</span><span class="token punctuation">,</span>\n      <span class="token property">&quot;streamSettings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n        <span class="token property">&quot;sockopt&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n          <span class="token property">&quot;tproxy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tproxy&quot;</span>\n        <span class="token punctuation">}</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;outbounds&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n    <span class="token punctuation">{</span>\n      <span class="token comment">// Your server configuration</span>\n    <span class="token punctuation">}</span>\n  <span class="token punctuation">]</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="_3-configuring-the-maximum-number-of-open-files-and-run-the-xray-client" tabindex="-1"><a class="header-anchor" href="#_3-configuring-the-maximum-number-of-open-files-and-run-the-xray-client" aria-hidden="true">#</a> 3. Configuring the maximum number of open files and run the Xray client</h3>',13),S=(0,a.Uk)("About the maximum number of open files, see: "),I={href:"https://guide.v2fly.org/app/tproxy.html#%E8%A7%A3%E5%86%B3-too-many-open-files-%E9%97%AE%E9%A2%98",target:"_blank",rel:"noopener noreferrer"},M=(0,a.Uk)("too many open files issues"),O=(0,a.uE)('<p>The current Xray server installed with the official script has the maximum number of open files automatically configured, so no further changes are required.</p><p><strong>Android</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">ulimit</span> -SHn <span class="token number">1000000</span>\nsetuidgid <span class="token number">0</span>:23333 <span class="token string">&quot;Command to run Xray&quot;</span><span class="token operator">&amp;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>Other Linux system</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">ulimit</span> -SHn <span class="token number">1000000</span>\n<span class="token function">sudo</span> -u xray_tproxy <span class="token string">&quot;Command to run Xray&quot;</span><span class="token operator">&amp;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>e.g.:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">ulimit</span> -SHn <span class="token number">1000000</span>\n<span class="token function">sudo</span> -u xray_tproxy xray -c /etc/xray/config.json <span class="token operator">&amp;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><em>The first command:</em></p><p>Change the maximum number of open files, valid only for the current terminal and to be run every time before starting Xray, this command is to set the maximum number of open files for the client.</p><p><em>The second command:</em></p><p>Run the Xray client as a user with uid 0 and gid not 0, followed by &amp; for running in the background.</p><p><strong>Check if the maximum number of open files is set successfully</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> /proc/<span class="token string">&quot;Xray&#39;s pid&quot;</span>/limits\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>Find max open files, which should be the value you set. Xray&#39;s pid can be obtained by running <code>ps</code> or <code>ps -aux</code> or <code>ps -a</code></p><p>Both the server and client side should be checked.</p><h3 id="_4-setting-up-iptables-rules" tabindex="-1"><a class="header-anchor" href="#_4-setting-up-iptables-rules" aria-hidden="true">#</a> 4. Setting up iptables rules</h3><p><strong>Proxy ipv4</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">ip</span> rule <span class="token function">add</span> fwmark <span class="token number">1</span> table <span class="token number">100</span>\n<span class="token function">ip</span> route <span class="token function">add</span> <span class="token builtin class-name">local</span> <span class="token number">0.0</span>.0.0/0 dev lo table <span class="token number">100</span>\n\n<span class="token comment"># Proxy LAN devices</span>\niptables -t mangle -N XRAY\n<span class="token comment"># &quot;ipv4 segment where the gateway is located&quot; is obtained by running the command &quot;ip address | grep -w inet | awk &#39;{print $2}&#39;&quot;, usually there are multiple</span>\niptables -t mangle -A XRAY -d <span class="token string">&quot;first ipv4 segment where the gateway is located&quot;</span> -j RETURN\niptables -t mangle -A XRAY -d <span class="token string">&quot;second ipv4 segment where the gateway is located&quot;</span> -j RETURN\n\n<span class="token comment"># If the gateway is used as the primary router, add this line, see: [Other considerations for transparent proxy of iptables](https://xtls.github.io/en/documents/level-2/transparent_proxy/transparent_proxy/#proxy-ipv6)</span>\n<span class="token comment"># The &quot;gateway LAN_IPv4 address segment&quot;, obtained by running the command &quot;ip address | grep -w &quot;inet&quot; | awk &#39;{print $2}&#39;&quot;, is one of the results</span>\niptables -t mangle -A XRAY <span class="token operator">!</span> -s <span class="token string">&quot;gateway LAN_IPv4 address segment&quot;</span> -j RETURN\n\n<span class="token comment"># Mark 1 for TCP and forward to port 12345</span>\n<span class="token comment"># mark can only be set to 1 for the traffic to be accepted by the Xray dokodemo-door</span>\niptables -t mangle -A XRAY -p tcp -j TPROXY --on-port <span class="token number">12345</span> --tproxy-mark <span class="token number">1</span>\niptables -t mangle -A XRAY -p udp -j TPROXY --on-port <span class="token number">12345</span> --tproxy-mark <span class="token number">1</span>\n<span class="token comment"># Apply rules</span>\niptables -t mangle -A PREROUTING -j XRAY\n\n<span class="token comment"># Proxy gateway itself</span>\niptables -t mangle -N XRAY_MASK\niptables -t mangle -A XRAY_MASK -d <span class="token string">&quot;the first ipv4 segment where the gateway is located&quot;</span> -j RETURN\niptables -t mangle -A XRAY_MASK -d <span class="token string">&quot;the second ipv4 segment where the gateway is located&quot;</span> -j RETURN\n\niptables -t mangle -A XRAY_MASK -j MARK --set-mark <span class="token number">1</span>\niptables -t mangle -A OUTPUT -m owner <span class="token operator">!</span> --gid-owner <span class="token number">23333</span> <span class="token operator">!</span> -p icmp -j XRAY_MASK\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><strong>Proxy ipv6 (optional)</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">ip</span> -6 rule <span class="token function">add</span> fwmark <span class="token number">1</span> table <span class="token number">106</span>\n<span class="token function">ip</span> -6 route <span class="token function">add</span> <span class="token builtin class-name">local</span> ::/0 dev lo table <span class="token number">106</span>\n\n<span class="token comment"># Proxy LAN devices</span>\nip6tables -t mangle -N XRAY6\n<span class="token comment"># The &quot;ipv6 segment where the gateway is located&quot; is obtained by running the command &quot;ip address | grep -w inet6 | awk &#39;{print $2}&#39;&quot;.</span>\nip6tables -t mangle -A XRAY6 -d <span class="token string">&quot;the first ipv6 segment where the gateway is located&quot;</span> -j RETURN\nip6tables -t mangle -A XRAY6 -d <span class="token string">&quot;the second ipv6 segment where the gateway is located&quot;</span> -j RETURN\n\n<span class="token comment"># If the gateway is used as the primary router, add this line, see: [Other considerations for transparent proxy of iptables](https://xtls.github.io/en/documents/level-2/transparent_proxy/transparent_proxy/#proxy-ipv6)</span>\n<span class="token comment"># The &quot;gateway LAN_IPv6 address segment&quot;, obtained by running the command &quot;ip address | grep -w &quot;inet6&quot; | awk &#39;{print $2}&#39;&quot;, is one of the results</span>\nip6tables -t mangle -A XRAY6 <span class="token operator">!</span> -s <span class="token string">&quot;gateway LAN_IPv6 address segment&quot;</span> -j RETURN\n\nip6tables -t mangle -A XRAY6 -p udp -j TPROXY --on-port <span class="token number">12345</span> --tproxy-mark <span class="token number">1</span>\nip6tables -t mangle -A XRAY6 -p tcp -j TPROXY --on-port <span class="token number">12345</span> --tproxy-mark <span class="token number">1</span>\nip6tables -t mangle -A PREROUTING -j XRAY6\n\n<span class="token comment"># Proxy gateway itself</span>\nip6tables -t mangle -N XRAY6_MASK\nip6tables -t mangle -A XRAY6_MASK -d <span class="token string">&quot;the first ipv6 segment where the gateway is located&quot;</span> -j RETURN\nip6tables -t mangle -A XRAY6_MASK -d <span class="token string">&quot;the second ipv6 segment where the gateway is located&quot;</span> -j RETURN\n\nip6tables -t mangle -A XRAY6_MASK -j MARK --set-mark <span class="token number">1</span>\nip6tables -t mangle -A OUTPUT -m owner <span class="token operator">!</span> --gid-owner <span class="token number">23333</span> <span class="token operator">!</span> -p icmp -j XRAY6_MASK\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div>',20),C={render:function(n,s){const e=(0,a.up)("OutboundLink"),C=(0,a.up)("RouterLink");return(0,a.wg)(),(0,a.iD)(a.HY,null,[r,(0,a._)("p",null,[t,(0,a._)("strong",null,[(0,a._)("a",p,[o,(0,a.Wm)(e)])]),l,(0,a._)("strong",null,[(0,a._)("a",i,[u,(0,a.Wm)(e)])]),c,(0,a._)("strong",null,[(0,a.Wm)(C,{to:"/en/document/level-2/tproxy.html"},{default:(0,a.w5)((()=>[d])),_:1})]),m]),b,(0,a._)("ol",null,[(0,a._)("li",null,[(0,a._)("p",null,[(0,a._)("strong",null,[(0,a._)("a",h,[g,(0,a.Wm)(e)])])])]),f]),y,(0,a._)("ol",null,[k,(0,a._)("li",null,[(0,a._)("p",null,[x,(0,a._)("strong",null,[(0,a._)("a",v,[_,(0,a.Wm)(e)])])])]),A]),w,(0,a._)("p",null,[q,(0,a._)("strong",null,[(0,a._)("a",R,[T,(0,a.Wm)(e)])]),X,(0,a._)("strong",null,[(0,a._)("a",U,[P,(0,a.Wm)(e)])]),Y,N,j]),E,(0,a._)("p",null,[S,(0,a._)("strong",null,[(0,a._)("a",I,[M,(0,a.Wm)(e)])])]),O],64)}}}}]);