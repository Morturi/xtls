"use strict";(self.webpackChunkXray_docs_next=self.webpackChunkXray_docs_next||[]).push([[4339],{6655:(e,t,o)=>{o.r(t),o.d(t,{data:()=>n});const n={key:"v-4bbe1d5a",path:"/en/config/routing.html",title:"Routing",lang:"en-US",frontmatter:{},excerpt:"",headers:[{level:2,title:"RoutingObject",slug:"routingobject",children:[{level:3,title:"RuleObject",slug:"ruleobject",children:[]},{level:3,title:"BalancerObject",slug:"balancerobject",children:[]},{level:3,title:"Predefined Domain Lists",slug:"predefined-domain-lists",children:[]}]}],filePathRelative:"en/config/routing.md",git:{updatedTime:1678585494e3,contributors:[{name:"Winston2084",email:"126307318+Winston2084@users.noreply.github.com",commits:1},{name:"hmol233",email:"82594500+hmol233@users.noreply.github.com",commits:1},{name:"yuhan6665",email:"1588741+yuhan6665@users.noreply.github.com",commits:1}]}}},39502:(e,t,o)=>{o.r(t),o.d(t,{default:()=>te});var n=o(66252);const a=(0,n._)("h1",{id:"routing",tabindex:"-1"},[(0,n._)("a",{class:"header-anchor",href:"#routing","aria-hidden":"true"},"#"),(0,n.Uk)(" Routing")],-1),s=(0,n._)("p",null,"The routing module can send inbound data through different outbound connections according to different rules to achieve on-demand proxying.",-1),i=(0,n._)("p",null,"A common use case is to split domestic and foreign traffic. Xray can use its internal mechanisms to determine the traffic from different regions and then send them to different outbound proxies.",-1),c=(0,n.Uk)("For a more detailed analysis of the routing function, please refer to "),r={href:"https://xtls.github.io/document/level-1/routing-lv1-part1.html",target:"_blank",rel:"noopener noreferrer"},l=(0,n.Uk)("Routing Function Analysis"),u=(0,n.Uk)("."),p=(0,n.uE)('<h2 id="routingobject" tabindex="-1"><a class="header-anchor" href="#routingobject" aria-hidden="true">#</a> RoutingObject</h2><p><code>RoutingObject</code> corresponds to the <code>routing</code> item in the configuration file.</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>\n  <span class="token property">&quot;routing&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token property">&quot;domainStrategy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;AsIs&quot;</span><span class="token punctuation">,</span>\n    <span class="token property">&quot;domainMatcher&quot;</span><span class="token operator">:</span> <span class="token string">&quot;hybrid&quot;</span><span class="token punctuation">,</span>\n    <span class="token property">&quot;rules&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n    <span class="token property">&quot;balancers&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p><code>domainStrategy</code>: &quot;AsIs&quot; | &quot;IPIfNonMatch&quot; | &quot;IPOnDemand&quot;</p></blockquote><p>The domain name resolution strategy, which uses different strategies based on different settings.</p><ul><li><p><code>&quot;AsIs&quot;</code>: Use only the domain name for routing selection. Default value.</p></li><li><p><code>&quot;IPIfNonMatch&quot;</code>: If the domain name does not match any rule, resolve the domain name into an IP address (A record or AAAA record) and match it again;</p><ul><li>When a domain name has multiple A records, it will try to match all A records until one of them matches a rule;</li><li>The resolved IP only works for routing selection, and the original domain name is still used in the forwarded packets;</li></ul></li><li><p><code>&quot;IPOnDemand&quot;</code>: If any IP-based rules are encountered during matching, immediately resolve the domain name into an IP address for matching;</p></li></ul><blockquote><p><code>domainMatcher</code>: &quot;hybrid&quot; | &quot;linear&quot;</p></blockquote><p>The domain name matching algorithm, which uses different algorithms based on different settings. This option affects all <code>RuleObject</code> that do not have a separately specified matching algorithm.</p><ul><li><code>&quot;hybrid&quot;</code>: Use the new domain name matching algorithm, which is faster and takes up less space. Default value.</li><li><code>&quot;linear&quot;</code>: Use the original domain name matching algorithm.</li></ul><blockquote><p><code>rules</code>: [<a href="#ruleobject">RuleObject</a>]</p></blockquote><p>An array corresponding to a list of rules.</p><p>For each connection, the routing will judge these rules from top to bottom in order. When it encounters the first effective rule, it will forward the connection to the <code>outboundTag</code> or <code>balancerTag</code> specified by the rule.</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>When no rules match, the traffic is sent out by the first outbound by default.</p></div><blockquote><p><code>balancers</code>: [ <a href="#balancerobject">BalancerObject</a> ]</p></blockquote><p>An array corresponding to a list of load balancers.</p><p>When a rule points to a load balancer, Xray selects an outbound through this load balancer, and then it forwards the traffic through it.</p><h3 id="ruleobject" tabindex="-1"><a class="header-anchor" href="#ruleobject" aria-hidden="true">#</a> RuleObject</h3><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>\n  <span class="token property">&quot;domainMatcher&quot;</span><span class="token operator">:</span> <span class="token string">&quot;hybrid&quot;</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;field&quot;</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;domain&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;baidu.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;qq.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;geosite:cn&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;ip&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;0.0.0.0/8&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;10.0.0.0/8&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fc00::/7&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fe80::/10&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;geoip:cn&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token string">&quot;53,443,1000-2000&quot;</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;sourcePort&quot;</span><span class="token operator">:</span> <span class="token string">&quot;53,443,1000-2000&quot;</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;network&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;10.0.0.1&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;user&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;love@xray.com&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;inboundTag&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;tag-vmess&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;tls&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bittorrent&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;attrs&quot;</span><span class="token operator">:</span> <span class="token string">&quot;attrs[&#39;:method&#39;] == &#39;GET&#39;&quot;</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;outboundTag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;direct&quot;</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;balancerTag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;balancer&quot;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><div class="custom-container danger"><p class="custom-container-title">DANGER</p><p>When multiple attributes are specified at the same time, these attributes need to be satisfied <strong>simultaneously</strong> in order for the current rule to take effect.</p></div><blockquote><p><code>domainMatcher</code>: &quot;hybrid&quot; | &quot;linear&quot;</p></blockquote><p>The domain matching algorithm used varies depending on the settings. The option here takes priority over the <code>domainMatcher</code> configured in <code>RoutingObject</code>.</p><ul><li><code>&quot;hybrid&quot;</code>: uses a new domain matching algorithm that is faster and takes up less space. This is the default value.</li><li><code>&quot;linear&quot;</code>: uses the original domain matching algorithm.</li></ul><blockquote><p><code>type</code>: &quot;field&quot;</p></blockquote><p>Currently, only the option <code>&quot;field&quot;</code> is supported.</p><blockquote><p><code>domain</code>: [string]</p></blockquote><p>An array where each item is a domain match. There are several forms:</p>',26),d=(0,n.uE)('<li>Plain string: If this string matches any part of the target domain, the rule takes effect. For example, &quot;sina.com&quot; can match &quot;sina.com&quot;, &quot;sina.com.cn&quot;, and &quot;www.sina.com&quot;, but not &quot;sina.cn&quot;.</li><li>Regular expression: Starts with <code>&quot;regexp:&quot;</code> followed by a regular expression. When this regular expression matches the target domain, the rule takes effect. For example, &quot;regexp:\\.goo.*\\.com$&quot; matches &quot;www.google.com&quot; or &quot;fonts.googleapis.com&quot;, but not &quot;google.com&quot;.</li><li>Subdomain (recommended): Starts with <code>&quot;domain:&quot;</code> followed by a domain. When this domain is the target domain or a subdomain of the target domain, the rule takes effect. For example, &quot;domain:xray.com&quot; matches &quot;www.xray.com&quot; and &quot;xray.com&quot;, but not &quot;wxray.com&quot;.</li><li>Exact match: Starts with <code>&quot;full:&quot;</code> followed by a domain. When this domain is an exact match for the target domain, the rule takes effect. For example, &quot;full:xray.com&quot; matches &quot;xray.com&quot; but not &quot;www.xray.com&quot;.</li><li>Predefined domain list: Starts with <code>&quot;geosite:&quot;</code> followed by a name such as <code>geosite:google</code> or <code>geosite:cn</code>. The names and domain lists are listed in <a href="#predefined-domain-list">Predefined Domain List</a>.</li>',5),h=(0,n.Uk)("Load domains from a file: Formatted as "),m=(0,n._)("code",null,'"ext:file:tag"',-1),q=(0,n.Uk)(", where the file is stored in the "),f=(0,n.Uk)("resource directory"),b=(0,n.Uk)(" and has the same format as "),g=(0,n._)("code",null,"geosite.dat",-1),k=(0,n.Uk)(". The tag must exist in the file."),y=(0,n._)("div",{class:"custom-container tip"},[(0,n._)("p",{class:"custom-container-title"},"TIP"),(0,n._)("p",null,[(0,n._)("code",null,'"ext:geoip.dat:cn"'),(0,n.Uk)(" is equivalent to "),(0,n._)("code",null,'"geoip:cn"')])],-1),w=(0,n._)("p",null,[(0,n._)("code",null,"ip"),(0,n.Uk)(": [string]")],-1),v=(0,n._)("p",null,"An array where each item represents an IP range. This rule will take effect when the target IP matches any of the IP ranges in the array. There are several types of IP ranges:",-1),T=(0,n._)("li",null,[(0,n._)("p",null,[(0,n.Uk)("IP: In the format of "),(0,n._)("code",null,'"127.0.0.1"'),(0,n.Uk)(".")])],-1),x={href:"https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing",target:"_blank",rel:"noopener noreferrer"},_=(0,n.Uk)("CIDR"),I=(0,n.Uk)(": In the format of "),P=(0,n._)("code",null,'"10.0.0.0/8"',-1),U=(0,n.Uk)("."),j=(0,n.uE)("<li><p>Predefined IP lists: These lists are included in every Xray installation package under the file name <code>geoip.dat</code>. They can be used in the format of <code>&quot;geoip:cn&quot;</code>, where <code>cn</code> is a two-letter country code. The prefix <code>geoip:</code>(all lowercase) must be used, and nearly all countries that have internet access are supported.</p><ul><li>Special value: <code>&quot;geoip:private&quot;</code>, which includes all private addresses, such as <code>127.0.0.1</code>.</li></ul></li>",1),C=(0,n.Uk)("Loading IP from a file: In the format of "),A=(0,n._)("code",null,'"ext:file:tag"',-1),R=(0,n.Uk)(", where "),W=(0,n._)("code",null,"file",-1),D=(0,n.Uk)(" is the file name and "),O=(0,n._)("code",null,"tag",-1),S=(0,n.Uk)(" is a label that must exist in the file. The prefix "),E=(0,n._)("code",null,"ext:",-1),F=(0,n.Uk)(" (all lowercase) must be used, and the file should be located in the "),L=(0,n.Uk)("resource directory"),M=(0,n.Uk)(" with the same format as "),G=(0,n._)("code",null,"geoip.dat",-1),N=(0,n.Uk)("."),X=(0,n.uE)('<blockquote><p><code>port</code>: number | string</p></blockquote><p>The target port range, which can take on three forms:</p><ul><li><code>&quot;a-b&quot;</code>: <code>a</code> and <code>b</code> are both positive integers less than 65536. This range is a closed interval, and this rule will take effect when the target port falls within this range.</li><li><code>a</code>: <code>a</code> is a positive integer less than 65536. This rule will take effect when the target port is <code>a</code>.</li><li>A mixture of the above two forms, separated by commas &quot;,&quot;. For example: <code>&quot;53,443,1000-2000&quot;</code>.</li></ul><blockquote><p><code>sourcePort</code>: number | string</p></blockquote><p>The source port, which can take on three forms:</p><ul><li><code>&quot;a-b&quot;</code>: <code>a</code> and <code>b</code> are both positive integers less than 65536. This range is a closed interval, and this rule will take effect when the source port falls within this range.</li><li><code>a</code>: <code>a</code> is a positive integer less than 65536. This rule will take effect when the source port is <code>a</code>.</li><li>A mixture of the above two forms, separated by commas &quot;,&quot;. For example: <code>&quot;53,443,1000-2000&quot;</code>.</li></ul><blockquote><p><code>network</code>: &quot;tcp&quot; | &quot;udp&quot; | &quot;tcp,udp&quot;</p></blockquote><p>This can be &quot;tcp&quot;, &quot;udp&quot;, or &quot;tcp,udp&quot;. This rule will take effect when the connection method is the specified one.</p><blockquote><p><code>source</code>: [string]</p></blockquote><p>An array where each item represents an IP range in the format of IP, CIDR, GeoIP, or loading IP from a file. This rule will take effect when the source IP matches any of the IP ranges in the array.</p><blockquote><p><code>user</code>: [string]</p></blockquote><p>An array where each item represents an email address. This rule will take effect when the source user matches any of the email addresses in the array.</p><blockquote><p><code>inboundTag</code>: [string]</p></blockquote><p>An array where each item represents an identifier. This rule will take effect when the inbound protocol matches any of the identifiers in the array.</p><blockquote><p><code>protocol</code>: [ &quot;http&quot; | &quot;tls&quot; | &quot;bittorrent&quot; ]</p></blockquote><p>An array where each item represents a protocol. This rule will take effect when the protocol of the current connection matches any of the protocols in the array.</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p>The <code>sniffing</code> option in the inbound proxy must be enabled to detect the protocol type used by the connection.</p></div><p><code>attrs</code>: string</p><p>A script used to detect the attribute values of the traffic. When this script returns a truthy value, this rule takes effect.</p>',19),H=(0,n.Uk)("The script language is "),B={href:"https://github.com/bazelbuild/starlark",target:"_blank",rel:"noopener noreferrer"},Y=(0,n.Uk)("Starlark"),z=(0,n.Uk)(", which is a subset of Python syntax. The script accepts a global variable "),J=(0,n._)("code",null,"attrs",-1),K=(0,n.Uk)(", which contains traffic-related attributes."),$=(0,n.uE)('<p>Currently, only the inbound HTTP proxy sets this attribute.</p><p>Examples:</p><ul><li>Detect HTTP GET: <code>&quot;attrs[&#39;:method&#39;] == &#39;GET&#39;&quot;</code></li><li>Detect HTTP Path: <code>&quot;attrs[&#39;:path&#39;].startswith(&#39;/test&#39;)&quot;</code></li><li>Detect Content Type: <code>&quot;attrs[&#39;accept&#39;].index(&#39;text/html&#39;) &gt;= 0&quot;</code></li></ul><blockquote><p><code>outboundTag</code>: string</p></blockquote><p>Corresponds to the identifier of an outbound.</p><blockquote><p><code>balancerTag</code>: string</p></blockquote><p>Corresponds to the identifier of a balancer.</p><div class="custom-container tip"><p class="custom-container-title">TIP</p><p><code>balancerTag</code> and <code>outboundTag</code> are mutually exclusive. When both are specified, <code>outboundTag</code> takes effect.</p></div><h3 id="balancerobject" tabindex="-1"><a class="header-anchor" href="#balancerobject" aria-hidden="true">#</a> BalancerObject</h3><p>Load balancer configuration. When a load balancer is in effect, it selects the most appropriate outbound from the specified outbound according to the configuration and forwards traffic.</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>\n  <span class="token property">&quot;tag&quot;</span><span class="token operator">:</span> <span class="token string">&quot;balancer&quot;</span><span class="token punctuation">,</span>\n  <span class="token property">&quot;selector&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><blockquote><p><code>tag</code>: string</p></blockquote><p>The identifier of this load balancer, used to match <code>balancerTag</code> in <code>RuleObject</code>.</p><blockquote><p><code>selector</code>: [ string ]</p></blockquote><p>An array of strings, each of which will be used to match the prefix of the outbound identifier. For example, in the following outbound identifiers: <code>[ &quot;a&quot;, &quot;ab&quot;, &quot;c&quot;, &quot;ba&quot; ]</code>, <code>&quot;selector&quot;: [&quot;a&quot;]</code> will match <code>[ &quot;a&quot;, &quot;ab&quot; ]</code>.</p><p>If multiple outbounds are matched, the load balancer currently selects one randomly as the final outbound.</p><h3 id="predefined-domain-lists" tabindex="-1"><a class="header-anchor" href="#predefined-domain-lists" aria-hidden="true">#</a> Predefined Domain Lists</h3><p>This list is included in every Xray installation package, and the file name is <code>geosite.dat</code>. This file contains some common domain names, which can be used as <code>geosite:filename</code> to perform routing or DNS filtering for domain names that match those in the file.</p><p>Common domain lists include:</p><ul><li><code>category-ads</code>: Contains common advertising domain names.</li><li><code>category-ads-all</code>: Contains common advertising domain names and advertising provider domain names.</li><li><code>cn</code>: Equivalent to the combination of <code>geolocation-cn</code> and <code>tld-cn</code>.</li><li><code>apple</code>: Contains most of the domain names under Apple.</li><li><code>google</code>: Contains most of the domain names under Google.</li><li><code>microsoft</code>: Contains most of the domain names under Microsoft.</li><li><code>facebook</code>: Contains most of the domain names under Facebook.</li><li><code>twitter</code>: Contains most of the domain names under Twitter.</li><li><code>telegram</code>: Contains most of the domain names under Telegram.</li><li><code>geolocation-cn</code>: Contains common domain names of mainland Chinese websites.</li><li><code>geolocation-!cn</code>: Contains common domain names of non-mainland Chinese websites, as well as <code>tld-!cn</code>.</li><li><code>tld-cn</code>: Contains top-level domain names managed by CNNIC for mainland China, such as domain names ending in <code>.cn</code> and <code>.中国</code>.</li><li><code>tld-!cn</code>: Contains top-level domain names used outside mainland China, such as domain names ending in <code>.hk</code> (Hong Kong), <code>.tw</code> (Taiwan), <code>.jp</code> (Japan), <code>.sg</code> (Singapore), <code>.us</code> (United States), and <code>.ca</code> (Canada).</li></ul>',20),Q=(0,n.Uk)("You can also find the complete list of domain names here: "),V={href:"https://github.com/v2fly/domain-list-community",target:"_blank",rel:"noopener noreferrer"},Z=(0,n.Uk)("Domain list community"),ee=(0,n.Uk)("."),te={render:function(e,t){const o=(0,n.up)("OutboundLink"),te=(0,n.up)("RouterLink");return(0,n.wg)(),(0,n.iD)(n.HY,null,[a,s,i,(0,n._)("p",null,[c,(0,n._)("a",r,[l,(0,n.Wm)(o)]),u]),p,(0,n._)("ul",null,[d,(0,n._)("li",null,[h,m,q,(0,n.Wm)(te,{to:"/en/config/features/env.html#resource-file-path"},{default:(0,n.w5)((()=>[f])),_:1}),b,g,k])]),y,w,v,(0,n._)("ul",null,[T,(0,n._)("li",null,[(0,n._)("p",null,[(0,n._)("a",x,[_,(0,n.Wm)(o)]),I,P,U])]),j,(0,n._)("li",null,[(0,n._)("p",null,[C,A,R,W,D,O,S,E,F,(0,n.Wm)(te,{to:"/en/config/features/env.html#resource-file-path"},{default:(0,n.w5)((()=>[L])),_:1}),M,G,N])])]),X,(0,n._)("p",null,[H,(0,n._)("a",B,[Y,(0,n.Wm)(o)]),z,J,K]),$,(0,n._)("p",null,[Q,(0,n._)("a",V,[Z,(0,n.Wm)(o)]),ee])],64)}}}}]);