<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.25">
    <link rel="icon" href="/logo.png"><title>Transparent proxy via GID | Project X</title><meta name="description" content="Official document of Xray">
    <link rel="preload" href="/assets/js/runtime~app.c50a0df4.js" as="script"><link rel="preload" href="/assets/css/styles.f4ef6178.css" as="style"><link rel="preload" href="/assets/js/3469.bd615835.js" as="script"><link rel="preload" href="/assets/js/app.3a46374a.js" as="script">
    <link rel="stylesheet" href="/assets/css/styles.f4ef6178.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/en/" class=""><!----><span class="site-name">Project X</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/en" class="nav-link router-link-active" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/en/about/news.md" class="nav-link" aria-label="大史记"><!--[--><!--]--> 大史记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/en/config/" class="nav-link" aria-label="配置指南"><!--[--><!--]--> 配置指南 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/en/development/" class="nav-link" aria-label="开发指南"><!--[--><!--]--> 开发指南 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/en/document/" class="nav-link router-link-active" aria-label="使用指南"><!--[--><!--]--> 使用指南 <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/document/level-2/iptables_gid.html" class="nav-link" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><li class="dropdown-item"><a aria-current="page" href="/en/document/level-2/iptables_gid.html" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="English (WIP)"><!--[--><!--]--> English (WIP) <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/xtls/xray-core" rel="noopener noreferrer" target="_blank" aria-label="Source"><!--[--><!--]--> Source <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/en" class="nav-link router-link-active" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/en/about/news.md" class="nav-link" aria-label="大史记"><!--[--><!--]--> 大史记 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/en/config/" class="nav-link" aria-label="配置指南"><!--[--><!--]--> 配置指南 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/en/development/" class="nav-link" aria-label="开发指南"><!--[--><!--]--> 开发指南 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/en/document/" class="nav-link router-link-active" aria-label="使用指南"><!--[--><!--]--> 使用指南 <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/document/level-2/iptables_gid.html" class="nav-link" aria-label="简体中文"><!--[--><!--]--> 简体中文 <!--[--><!--]--></a></li><li class="dropdown-item"><a aria-current="page" href="/en/document/level-2/iptables_gid.html" class="router-link-active router-link-exact-active nav-link router-link-active" aria-label="English (WIP)"><!--[--><!--]--> English (WIP) <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/xtls/xray-core" rel="noopener noreferrer" target="_blank" aria-label="Source"><!--[--><!--]--> Source <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item active">进阶技巧</p><ul class=""><li><!--[--><a href="/en/document/level-2/transparent_proxy/transparent_proxy.html" class="nav-link sidebar-item" aria-label="透明代理入门"><!--[--><!--]--> 透明代理入门 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/en/document/level-2/tproxy.html" class="nav-link sidebar-item" aria-label="TProxy 透明代理"><!--[--><!--]--> TProxy 透明代理 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/en/document/level-2/tproxy_ipv4_and_ipv6.md" class="nav-link sidebar-item" aria-label="/en/document/level-2/tproxy_ipv4_and_ipv6.md"><!--[--><!--]--> /en/document/level-2/tproxy_ipv4_and_ipv6.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/en/document/level-2/nginx_tls_tunnel.md" class="nav-link sidebar-item" aria-label="/en/document/level-2/nginx_tls_tunnel.md"><!--[--><!--]--> /en/document/level-2/nginx_tls_tunnel.md <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/en/document/level-2/iptables_gid.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="Transparent proxy via GID"><!--[--><!--]--> Transparent proxy via GID <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/en/document/level-2/iptables_gid.html#ideas" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Ideas"><!--[--><!--]--> Ideas <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/en/document/level-2/iptables_gid.html#configuration-procedure" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Configuration Procedure"><!--[--><!--]--> Configuration Procedure <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/en/document/level-2/iptables_gid.html#_1-preliminary-preparation" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1. Preliminary preparation"><!--[--><!--]--> 1. Preliminary preparation <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/en/document/level-2/iptables_gid.html#_2-add-user-android-users-please-ignore-this-section" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="2. Add user (Android users please ignore this section)"><!--[--><!--]--> 2. Add user (Android users please ignore this section) <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/en/document/level-2/iptables_gid.html#_3-configure-and-run-xray-and-configure-iptables-rules" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="3. Configure and run Xray, and configure iptables rules"><!--[--><!--]--> 3. Configure and run Xray, and configure iptables rules <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/en/document/level-2/iptables_gid.html#steps" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Steps"><!--[--><!--]--> Steps <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/en/document/level-2/iptables_gid.html#_1-finish-preliminary-preparation-and-add-user" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="1. Finish Preliminary preparation and Add user"><!--[--><!--]--> 1. Finish Preliminary preparation and Add user <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/en/document/level-2/iptables_gid.html#_2-preparing-xray-profiles" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="2. Preparing Xray profiles"><!--[--><!--]--> 2. Preparing Xray profiles <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/en/document/level-2/iptables_gid.html#_3-configuring-the-maximum-number-of-open-files-and-run-the-xray-client" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="3. Configuring the maximum number of open files and run the Xray client"><!--[--><!--]--> 3. Configuring the maximum number of open files and run the Xray client <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/en/document/level-2/iptables_gid.html#_4-setting-up-iptables-rules" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="4. Setting up iptables rules"><!--[--><!--]--> 4. Setting up iptables rules <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--></li><li><!--[--><a href="/en/document/level-2/redirect.html" class="nav-link sidebar-item" aria-label="出站流量重定向"><!--[--><!--]--> 出站流量重定向 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/en/document/level-2/warp.html" class="nav-link sidebar-item" aria-label="通过 Cloudflare Warp 增强代理安全性"><!--[--><!--]--> 通过 Cloudflare Warp 增强代理安全性 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/en/document/level-2/traffic_stats.html" class="nav-link sidebar-item" aria-label="流量统计"><!--[--><!--]--> 流量统计 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="transparent-proxy-to-circumvent-xray-traffic-via-gid" tabindex="-1"><a class="header-anchor" href="#transparent-proxy-to-circumvent-xray-traffic-via-gid" aria-hidden="true">#</a> Transparent proxy to circumvent Xray traffic via GID</h1><p>In the existing transparent proxy configuration(<strong><a href="https://guide.v2fly.org/app/transparent_proxy.html" target="_blank" rel="noopener noreferrer">New V2Ray vernacular tutorial on transparent proxy<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></strong> 、 <strong><a href="https://guide.v2fly.org/app/tproxy.html" target="_blank" rel="noopener noreferrer">New V2Ray vernacular tutorial on transparent proxy (TProxy)<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></strong> 、 <strong><a href="/en/document/level-2/tproxy.html" class="">Transparent proxy（TProxy）configuration tutorial</a></strong>)tutorials, the circumvention of Xray traffic is achieved by using mark. That is, mark outbound traffics and set up iptables rules which directly connect traffics corresponding to the mark, to circumvent the Xray traffic and prevent loop back.</p><p>There are several problems with this method:</p><ol><li><p><strong><a href="https://github.com/v2ray/v2ray-core/issues/2621" target="_blank" rel="noopener noreferrer">Inexplicable traffic into PREROUTING chain<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></strong></p></li><li><p>Android has its own mark mechanism and this solution is not available on Android</p></li></ol><p>The solution in this tutorial does not require a mark setting and has a higher theoretical performance, as well as not having the problems mentioned above.</p><h2 id="ideas" tabindex="-1"><a class="header-anchor" href="#ideas" aria-hidden="true">#</a> Ideas</h2><p>TProxy traffic can only be received by users with root privileges (uid==0) or other users with CAP_NET_ADMIN privileges.</p><p>The iptables rules can separate network traffic by uid (user id) and gid (user group id). Let Xray run on a user with uid==0 but gid!=0. Set the iptables rule to not proxy traffic for that gid to circumvent Xray traffic.</p><h2 id="configuration-procedure" tabindex="-1"><a class="header-anchor" href="#configuration-procedure" aria-hidden="true">#</a> Configuration Procedure</h2><h3 id="_1-preliminary-preparation" tabindex="-1"><a class="header-anchor" href="#_1-preliminary-preparation" aria-hidden="true">#</a> 1. Preliminary preparation</h3><p><strong>Android</strong></p><ol><li><p>System has root privilege.</p></li><li><p>Install <strong><a href="https://play.google.com/store/apps/details?id=stericson.busybox" target="_blank" rel="noopener noreferrer">busybox<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></strong></p></li><li><p>There is a terminal that can execute commands, you can use adb shell, termux etc.</p></li></ol><p><strong>Other Linux system</strong></p><p>Need sudo, iptables-tproxy module and iptables-extra module。</p><p>Usually the system comes with these functions. If you are using openwrt, you will need to run the following command:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>opkg <span class="token function">install</span> <span class="token function">sudo</span> iptables-mod-tproxy iptables-mod-extra
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>Also attached are some common dependencies for openwrt, the lack of which may prevent Xray from running</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>opkg <span class="token function">install</span> libopenssl ca-certificates
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><h3 id="_2-add-user-android-users-please-ignore-this-section" tabindex="-1"><a class="header-anchor" href="#_2-add-user-android-users-please-ignore-this-section" aria-hidden="true">#</a> 2. Add user (Android users please ignore this section)</h3><p>Android does not support managing users by modifying the /etc/passwd file, please ignore it and go straight to the next step.</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">grep</span> -qw xray_tproxy /etc/passwd <span class="token operator">||</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;xray_tproxy:x:0:23333:::&quot;</span> <span class="token operator">&gt;&gt;</span> /etc/passwd
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>where xray_tproxy is the username, 0 is the uid and 23333 is the gid, the username and gid can be set by yourself, the uid must be 0. To check if the user was added successfully, run</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> -u xray_tproxy <span class="token function">id</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>The result displayed should be uid 0 and gid 23333.</p><h3 id="_3-configure-and-run-xray-and-configure-iptables-rules" tabindex="-1"><a class="header-anchor" href="#_3-configure-and-run-xray-and-configure-iptables-rules" aria-hidden="true">#</a> 3. Configure and run Xray, and configure iptables rules</h3><p>In the existing transparent proxy configuration(<strong><a href="https://guide.v2fly.org/app/transparent_proxy.html" target="_blank" rel="noopener noreferrer">New V2Ray vernacular tutorial on transparent proxy<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></strong> 、 <strong><a href="https://guide.v2fly.org/app/tproxy.html" target="_blank" rel="noopener noreferrer">New V2Ray vernacular tutorial on transparent proxy (TProxy)<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></strong> 、 <strong><a href="../tproxy">Transparent proxy（TProxy）configuration tutorial</a></strong>)tutorials, modify:</p><ol><li><p>Modify the json configuration file: remove mark-related content</p></li><li><p>Modify the iptables rule to remove the mark-related content and add the option at the OUTPUT chain application rule: <code>-m owner ! --gid-owner 23333</code></p></li></ol><p>e.g.:</p><p><code>iptables -t mangle -A OUTPUT -j XRAY_SELF</code></p><p>Change to</p><p><code>iptables -t mangle -A OUTPUT -m owner ! --gid-owner 23333 -j XRAY_SELF</code></p><ol><li>Modify the way you run Xray so that it runs on a user with uid 0 and gid 23333, refer to <a href="#_3-configure-and-run-xray-and-configure-iptables-rules">here</a>.</li></ol><h2 id="steps" tabindex="-1"><a class="header-anchor" href="#steps" aria-hidden="true">#</a> Steps</h2><p>The following provides a complete configuration process for implementing the tproxy global proxy</p><h3 id="_1-finish-preliminary-preparation-and-add-user" tabindex="-1"><a class="header-anchor" href="#_1-finish-preliminary-preparation-and-add-user" aria-hidden="true">#</a> 1. Finish <strong><a href="#_1-preliminary-preparation">Preliminary preparation</a></strong> and <strong><a href="#_2-add-user-android-users-please-ignore-this-section">Add user</a></strong></h3><h3 id="_2-preparing-xray-profiles" tabindex="-1"><a class="header-anchor" href="#_2-preparing-xray-profiles" aria-hidden="true">#</a> 2. Preparing Xray profiles</h3><p>Configure Xray to listen to 12345 at dokodemo-door, turn on followRedirect and tproxy, no sniffing required:</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;inbounds&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">12345</span><span class="token punctuation">,</span>
      <span class="token property">&quot;protocol&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dokodemo-door&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;settings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;network&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tcp,udp&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;followRedirect&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;streamSettings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;sockopt&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;tproxy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tproxy&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;outbounds&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// Your server configuration</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="_3-configuring-the-maximum-number-of-open-files-and-run-the-xray-client" tabindex="-1"><a class="header-anchor" href="#_3-configuring-the-maximum-number-of-open-files-and-run-the-xray-client" aria-hidden="true">#</a> 3. Configuring the maximum number of open files and run the Xray client</h3><p>About the maximum number of open files, see: <strong><a href="https://guide.v2fly.org/app/tproxy.html#%E8%A7%A3%E5%86%B3-too-many-open-files-%E9%97%AE%E9%A2%98" target="_blank" rel="noopener noreferrer">too many open files issues<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></strong></p><p>The current Xray server installed with the official script has the maximum number of open files automatically configured, so no further changes are required.</p><p><strong>Android</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">ulimit</span> -SHn <span class="token number">1000000</span>
setuidgid <span class="token number">0</span>:23333 <span class="token string">&quot;Command to run Xray&quot;</span><span class="token operator">&amp;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>Other Linux system</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">ulimit</span> -SHn <span class="token number">1000000</span>
<span class="token function">sudo</span> -u xray_tproxy <span class="token string">&quot;Command to run Xray&quot;</span><span class="token operator">&amp;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>e.g.:</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">ulimit</span> -SHn <span class="token number">1000000</span>
<span class="token function">sudo</span> -u xray_tproxy xray -c /etc/xray/config.json <span class="token operator">&amp;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><em>The first command:</em></p><p>Change the maximum number of open files, valid only for the current terminal and to be run every time before starting Xray, this command is to set the maximum number of open files for the client.</p><p><em>The second command:</em></p><p>Run the Xray client as a user with uid 0 and gid not 0, followed by &amp; for running in the background.</p><p><strong>Check if the maximum number of open files is set successfully</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">cat</span> /proc/<span class="token string">&quot;Xray&#39;s pid&quot;</span>/limits
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>Find max open files, which should be the value you set. Xray&#39;s pid can be obtained by running <code>ps</code> or <code>ps -aux</code> or <code>ps -a</code></p><p>Both the server and client side should be checked.</p><h3 id="_4-setting-up-iptables-rules" tabindex="-1"><a class="header-anchor" href="#_4-setting-up-iptables-rules" aria-hidden="true">#</a> 4. Setting up iptables rules</h3><p><strong>Proxy ipv4</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">ip</span> rule <span class="token function">add</span> fwmark <span class="token number">1</span> table <span class="token number">100</span>
<span class="token function">ip</span> route <span class="token function">add</span> <span class="token builtin class-name">local</span> <span class="token number">0.0</span>.0.0/0 dev lo table <span class="token number">100</span>

<span class="token comment"># Proxy LAN devices</span>
iptables -t mangle -N XRAY
<span class="token comment"># &quot;ipv4 segment where the gateway is located&quot; is obtained by running the command &quot;ip address | grep -w inet | awk &#39;{print $2}&#39;&quot;, usually there are multiple</span>
iptables -t mangle -A XRAY -d <span class="token string">&quot;first ipv4 segment where the gateway is located&quot;</span> -j RETURN
iptables -t mangle -A XRAY -d <span class="token string">&quot;second ipv4 segment where the gateway is located&quot;</span> -j RETURN

<span class="token comment"># If the gateway is used as the primary router, add this line, see: [Other considerations for transparent proxy of iptables](https://xtls.github.io/en/documents/level-2/transparent_proxy/transparent_proxy/#proxy-ipv6)</span>
<span class="token comment"># The &quot;gateway LAN_IPv4 address segment&quot;, obtained by running the command &quot;ip address | grep -w &quot;inet&quot; | awk &#39;{print $2}&#39;&quot;, is one of the results</span>
iptables -t mangle -A XRAY <span class="token operator">!</span> -s <span class="token string">&quot;gateway LAN_IPv4 address segment&quot;</span> -j RETURN

<span class="token comment"># Mark 1 for TCP and forward to port 12345</span>
<span class="token comment"># mark can only be set to 1 for the traffic to be accepted by the Xray dokodemo-door</span>
iptables -t mangle -A XRAY -p tcp -j TPROXY --on-port <span class="token number">12345</span> --tproxy-mark <span class="token number">1</span>
iptables -t mangle -A XRAY -p udp -j TPROXY --on-port <span class="token number">12345</span> --tproxy-mark <span class="token number">1</span>
<span class="token comment"># Apply rules</span>
iptables -t mangle -A PREROUTING -j XRAY

<span class="token comment"># Proxy gateway itself</span>
iptables -t mangle -N XRAY_MASK
iptables -t mangle -A XRAY_MASK -d <span class="token string">&quot;the first ipv4 segment where the gateway is located&quot;</span> -j RETURN
iptables -t mangle -A XRAY_MASK -d <span class="token string">&quot;the second ipv4 segment where the gateway is located&quot;</span> -j RETURN

iptables -t mangle -A XRAY_MASK -j MARK --set-mark <span class="token number">1</span>
iptables -t mangle -A OUTPUT -m owner <span class="token operator">!</span> --gid-owner <span class="token number">23333</span> <span class="token operator">!</span> -p icmp -j XRAY_MASK
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p><strong>Proxy ipv6 (optional)</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">ip</span> -6 rule <span class="token function">add</span> fwmark <span class="token number">1</span> table <span class="token number">106</span>
<span class="token function">ip</span> -6 route <span class="token function">add</span> <span class="token builtin class-name">local</span> ::/0 dev lo table <span class="token number">106</span>

<span class="token comment"># Proxy LAN devices</span>
ip6tables -t mangle -N XRAY6
<span class="token comment"># The &quot;ipv6 segment where the gateway is located&quot; is obtained by running the command &quot;ip address | grep -w inet6 | awk &#39;{print $2}&#39;&quot;.</span>
ip6tables -t mangle -A XRAY6 -d <span class="token string">&quot;the first ipv6 segment where the gateway is located&quot;</span> -j RETURN
ip6tables -t mangle -A XRAY6 -d <span class="token string">&quot;the second ipv6 segment where the gateway is located&quot;</span> -j RETURN

<span class="token comment"># If the gateway is used as the primary router, add this line, see: [Other considerations for transparent proxy of iptables](https://xtls.github.io/en/documents/level-2/transparent_proxy/transparent_proxy/#proxy-ipv6)</span>
<span class="token comment"># The &quot;gateway LAN_IPv6 address segment&quot;, obtained by running the command &quot;ip address | grep -w &quot;inet6&quot; | awk &#39;{print $2}&#39;&quot;, is one of the results</span>
ip6tables -t mangle -A XRAY6 <span class="token operator">!</span> -s <span class="token string">&quot;gateway LAN_IPv6 address segment&quot;</span> -j RETURN

ip6tables -t mangle -A XRAY6 -p udp -j TPROXY --on-port <span class="token number">12345</span> --tproxy-mark <span class="token number">1</span>
ip6tables -t mangle -A XRAY6 -p tcp -j TPROXY --on-port <span class="token number">12345</span> --tproxy-mark <span class="token number">1</span>
ip6tables -t mangle -A PREROUTING -j XRAY6

<span class="token comment"># Proxy gateway itself</span>
ip6tables -t mangle -N XRAY6_MASK
ip6tables -t mangle -A XRAY6_MASK -d <span class="token string">&quot;the first ipv6 segment where the gateway is located&quot;</span> -j RETURN
ip6tables -t mangle -A XRAY6_MASK -d <span class="token string">&quot;the second ipv6 segment where the gateway is located&quot;</span> -j RETURN

ip6tables -t mangle -A XRAY6_MASK -j MARK --set-mark <span class="token number">1</span>
ip6tables -t mangle -A OUTPUT -m owner <span class="token operator">!</span> --gid-owner <span class="token number">23333</span> <span class="token operator">!</span> -p icmp -j XRAY6_MASK
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="nav-link external meta-item-label" href="https://github.com/xtls/Xray-docs-next/edit/main/docs/en/document/level-2/iptables_gid.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" ariahidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">5/26/2021, 12:25:44 PM</span></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 82594500+hmol233@users.noreply.github.com">hmol233</span><!--[-->, <!--]--><!--]--><!--[--><span class="contributor" title="email: 30682790+R3pl4c3r@users.noreply.github.com">R3pl4c3r</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/en/document/level-2/nginx_tls_tunnel.md" class="nav-link" aria-label="/en/document/level-2/nginx_tls_tunnel.md"><!--[--><!--]--> /en/document/level-2/nginx_tls_tunnel.md <!--[--><!--]--></a></span><span class="next"><a href="/en/document/level-2/redirect.html" class="nav-link" aria-label="出站流量重定向"><!--[--><!--]--> 出站流量重定向 <!--[--><!--]--></a> → </span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/assets/js/runtime~app.c50a0df4.js" defer></script><script src="/assets/js/3469.bd615835.js" defer></script><script src="/assets/js/app.3a46374a.js" defer></script>
  </body>
</html>
